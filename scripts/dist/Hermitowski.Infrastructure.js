/*! For license information please see Hermitowski.Infrastructure.js.LICENSE.txt */
(()=>{"use strict";var t={715:t=>{t.exports=JSON.parse('{"HEADER":"WTF - What a Terrible Failure","FORUM_THREAD":"Wątek na forum","DESCRIPTION":"Coś poszło nie tak. Jeżeli jesteś przekonany/a, że konfiguracja jest prawidłowa, wklej poniższe zaklęcie na forum wraz z krótkim opisem czynności, które doprowadziły do tej katastrofy"}')}},n={};function e(o){var r=n[o];if(void 0!==r)return r.exports;var i=n[o]={exports:{}};return t[o](i,i.exports,e),i.exports}(()=>{const t={create_instance:function(t){if(!window["Hermitowski.Tracing"]||!window["Hermitowski.Tracing"][t])return{log:function(){},entry:function(){},exit:function(){}};const n=(new Error).stack.split("\n").slice(1),e="color: green;",o=function(){var e=(new Error).stack.split("\n").slice(2);const o=[`%c${t}`];for(var i=1;i<=e.length;i++)if(n.length-i<0||n.length-i>=0&&e[e.length-i]!=n[n.length-i]){const t=r(e[e.length-i]);t.length>0&&o.push(t)}return o.push(""),o},r=function(t){let n=t.split("@")[0];const e=n.split("async*");return e.length>1&&(n=e[1]),n=n.trim(),n},i={};return{log:function(){const t=o();console.log.apply(void 0,[t.join(" | "),e,...arguments])},entry:function(){const t=o(),n=r(t[0]);i[n]=Date.now(),console.group.apply(void 0,[t.join(" | "),e,"Entry",...arguments])},exit:function(){const t=o(),n=r(t[0]),a=i[n],c=[t.join(" | "),e,`Exit | Elapsed time: ${Date.now()-a} [ms]`];arguments.length>0&&c.push(` Returning: ${arguments[0]}`),console.log.apply(void 0,c),console.groupEnd()}}}};async function n(t){"string"!=typeof t&&(t=JSON.stringify(t));const n=(new TextEncoder).encode(t),e=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(e)).map((t=>t.toString(16).padStart(2,"0"))).join("")}function o(t){return parseInt((void 0!==t?t.getTime():Date.now())/1e3)}async function r(t){const n=new Promise(((n,e)=>{t.onsuccess=function(t){n(t.target.result)},t.onerror=function(t){e(t)}}));return await n}function i(t,n){return Math.floor(Math.random()*(n-t)+t)}e(715);const a="name",c="value",s="expiration_time_s",u={create_instance:async function(){const e="Hermitowski.Storage",o=t.create_instance(e),i="storage",u="readwrite",l="readonly",f="relaxed";o.entry(arguments),o.log("Opening database");const g=window.indexedDB.open(e,1);g.onupgradeneeded=function(t){const n=t.target.result.createObjectStore(i,{keyPath:a,autoIncrement:!1});n.createIndex(a,a,{unique:!0}),n.createIndex(s,s,{unique:!1})};const w=await r(g),p=function(){return parseInt(Date.now()/1e3)};o.log("Deleting expired items");var d=w.transaction(i,u).objectStore(i).index(s).openCursor(IDBKeyRange.upperBound(p()));d.onsuccess=function(t){var n=t.target.result;n&&(o.log(n),n.delete(),n.continue())};const y=async function(t,e){return t+"."+("string"==typeof e?e:await n(e))};return o.exit(),{get_item:async function(t,n){o.entry(arguments);const e=await y(t,n),a=await r(w.transaction(i,l,{durability:f}).objectStore(i).get(e));return o.log(e,a,p()),o.exit(),a&&a.expiration_time_s>p()?a:null},set_item:async function(t,n,e,l){o.entry(arguments);const f=await y(t,n),g={[a]:f,[s]:p()+l,[c]:e};o.log(g),await r(w.transaction(i,u).objectStore(i).put(g)),o.exit()},get_or_add_item:async function(t,n,e){o.entry(arguments);const a=await y(t,n);let c=await r(w.transaction(i,l,{durability:f}).objectStore(i).get(a));return(!c||c.expiration_time_s<p())&&(c=await e(),c.name=a,o.log("created instance",c),await r(w.transaction(i,u,{durability:f}).objectStore(i).put(c))),c.name=n,o.log("returning",c),o.exit(),c}}}},l={create_instance:async function(e){const r="Hermitowski.MapFiles",l=t.create_instance(r),f=await u.create_instance(e),g=async function(t){l.entry(arguments);var n=[];for(const o of t){var e=f.get_or_add_item(r,o,(async function(){return await w(o)}));n.push(e)}var o=await Promise.all(n),i={};for(const t of o)i[t.name]=t;return l.exit(),i},w=async function(t){switch(t){case"village":return await p(t,(t=>({id:t[0],x:parseInt(t[2]),y:parseInt(t[3]),player_id:t[4]})));case"player":return await p(t,(t=>({id:t[0],name:t[1],ally_id:t[2]})));case"ally":return await p(t,(t=>({id:t[0],name:t[1],tag:t[2]})));case"building_info":case"unit_info":case"config":return await d(t);default:throw new Error(`Not supported entity name - ${t}`)}},p=async function(t,n){l.entry(arguments);const e=await fetch(`map/${t}.txt`),r=new Date(e.headers.get("last-modified")),u=await e.text(),f=u.split("\n"),g=f.filter((t=>t.trim().length>0)).map((t=>t.split(",").map((t=>m(t))))),w=[];for(const t of g)w.push(n(t));let p=o(r)+3600+i(15,120);return p<o()&&(p=o()+3600),l.exit(),{[a]:"",[s]:p,[c]:w}},d=async function(t){l.entry(arguments);const n=await fetch(`interface.php?func=get_${t}`),e=await n.text(),r=_(e);return l.exit(),{[a]:"",[s]:o()+3600,[c]:r}},y=new RegExp(/\+/,"g"),m=function(t){return decodeURIComponent(t.replace(y," "))},_=function(t){const n=(new window.DOMParser).parseFromString(t,"text/xml");return x(n.children[0])},x=function(t){let n={};if(0===t.childElementCount)return t.textContent;for(const e of t.children)n[e.nodeName]=x(e);return n};return{get_world_info:async function(t){l.entry(arguments);const n=await g(t);for(const e of t)n[e]=n[e].value;return l.exit(),n},get_item:async function(t){const n=await f.get_item(e,t);return n?n.value:null},set_item:async function(t,n,o){return await f.set_item(e,t,n,o)},get_or_compute:async function(t,o,r){l.entry(arguments);const i="string"==typeof r?r:await n(r),u=async function(){l.entry(arguments);const n=await g(o),e={};for(const t of o)e[t]=n[t].value;l.log("Passing following arguments into factory method",e,r);const i=await t(e,r);l.log("Computed result",i);const u=Math.min(...Object.keys(n).map((t=>n[t].expiration_time_s)));l.log("Expiration time set to",u);const f={[a]:"",[s]:u,[c]:i};return l.exit(),f};var w=await f.get_or_add_item(e,i,u);return l.exit(),w.value},get_or_compute_dynamic:async function(t,r,i){l.entry();const u=await n(t.toString()+JSON.stringify(r));l.log("Digest: ",u);var g=await f.get_or_add_item(e,u,(async function(){l.entry();const n=await t(r),e=o()+i;l.log("Expiration time set to",e);const u={[a]:"",[s]:e,[c]:n};return l.exit(),u}));return l.exit(),g.value}}}},f="Hermitowski.Infrastructure";window[f]=window[f]||{},window[f].Logger=t,window[f].Storage=u,window[f].MapFiles=l})()})();