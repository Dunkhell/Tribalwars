/*! For license information please see Hermitowski.Faking.js.LICENSE.txt */
(()=>{"use strict";var e={436:e=>{e.exports=JSON.parse('{"FORUM_THREAD_HREF":"https://forum.plemiona.pl/index.php?threads/hermitowskie-fejki.125294/","ATTACK_TIME":"Wojsko dojdzie __DAY__.__MONTH__ na __HOURS__:__MINUTES__<br/>Cel: __TARGET__ __PLAYER_INFO__","ERROR_FORUM_CONFIG_THREAD_ID":"forum_config.thread_id jest nieprawidłowy","ERROR_FORUM_CONFIG_SPOILER_NAME":"forum_config.spoiler_name jest nieprawidłowy","ERROR_FORUM_CONFIG_TTL":"forum_config.ttl jest nieprawidłowy","ERROR_FORUM_CONFIG_PAGE":"forum_config.page jest nieprawidłowy","ERROR_FORUM_CONFIG_THREAD_DOES_NOT_EXIST":"Wątek nie istnieje","ERROR_FORUM_CONFIG_SPOILER_NONE":"Spoiler o podanej nazwie nie istnieje","ERROR_FORUM_CONFIG_SPOILER_MULTIPLE":"Znaleziono więcej niż jeden spoiler o podanej nazwie","ERROR_FORUM_CONFIG_CODE_SNIPPET_NONE":"Wskazany spoiler nie zawiera konfiguracji","ERROR_FORUM_CONFIG_CODE_SNIPPET_MULTIPLE":"Wskazany spoiler zawiera więcej niż jedną konfigurację","ERROR_SCREEN_VILLAGE_OUT_OF_GROUP":"Wioska poza grupą. Przechodzę do następnej wioski z grupy","ERROR_SCREEN_REDIRECT":"Przechodzę do przeglądu placu","ERROR_SCREEN_NO_ACTION":"Na tym ekranie nie ma akcji do wykonania","ERROR_CONFIGURATION_MISSING":"Brak konfiguracji użytkownika","ERROR_CONFIGURATION_OPTION_UNKNOWN":"Nieznana opcja: __OPTION_NAME__","ERROR_TROOPS_NOT_ENOUGH":"Nie udało się wybrać wystarczającej liczby jednostek","ERROR_TROOPS_EMPTY":"Obecne ustawienia nie pozwalają na wybór jednostek","ERROR_POOL_EMPTY":"Obecne ustawienia nie definują żadnych celów","ERROR_POOL_EMPTY_SNOBS":"W puli wiosek pozostały wioski, leżące poza zasięgiem szlachciców","ERROR_POOL_EMPTY_BLOCKED_VILLAGES":"W puli wiosek pozostały wioski, które zostały niedawno wybrane","ERROR_POOL_EMPTY_BLOCKED_PLAYERS":"W puli wiosek pozostały wioski, które należą od ostatnio wybranych graczy","ERROR_POOL_EMPTY_NIGHT_BONUS":"W puli wiosek pozostały wioski, na które atak doszedłby w bonusie nocnym","ERROR_POOL_EMPTY_DATE_RANGES":"W puli wiosek pozostały wioski, na które atak doszedłby poza wybranym przedziałami czasowymi"}')},715:e=>{e.exports=JSON.parse('{"HEADER":"WTF - What a Terrible Failure","FORUM_THREAD":"Wątek na forum","DESCRIPTION":"Coś poszło nie tak. Jeżeli jesteś przekonany/a, że konfiguracja jest prawidłowa, wklej poniższe zaklęcie na forum wraz z krótkim opisem czynności, które doprowadziły do tej katastrofy"}')}},t={};function n(o){var i=t[o];if(void 0!==i)return i.exports;var r=t[o]={exports:{}};return e[o](r,r.exports,n),r.exports}(()=>{const e=function(e){if(!window["Hermitowski.Tracing"]||!window["Hermitowski.Tracing"][e])return{log:function(){},entry:function(){},exit:function(){}};const t=(new Error).stack.split("\n").slice(1),n="color: green;",o=function(){var n=(new Error).stack.split("\n").slice(2);const o=[`%c${e}`];for(var r=1;r<=n.length;r++)if(t.length-r<0||t.length-r>=0&&n[n.length-r]!=t[t.length-r]){const e=i(n[n.length-r]);e.length>0&&o.push(e)}return o.push(""),o},i=function(e){let t=e.split("@")[0];const n=t.split("async*");return n.length>1&&(t=n[1]),t=t.trim(),t},r={};return{log:function(){const e=o();console.log.apply(void 0,[e.join(" | "),n,...arguments])},entry:function(){const e=o(),t=i(e[0]);r[t]=Date.now(),console.group.apply(void 0,[e.join(" | "),n,"Entry",...arguments])},exit:function(){const e=o(),t=i(e[0]),a=r[t],l=[e.join(" | "),n,`Exit | Elapsed time: ${Date.now()-a} [ms]`];arguments.length>0&&l.push(` Returning: ${arguments[0]}`),console.log.apply(void 0,l),console.groupEnd()}}},t=n(715);function o(e,n){if("string"==typeof e)return void UI.ErrorMessage(e);const o=`<h2>${t.HEADER}</h2>\n        <p></p>\n            ${t.DESCRIPTION}\n            <textarea rows='12' cols='80'>${e}\n\n${e.stack}</textarea><br/>\n            <a href='${n}'>${t.FORUM_THREAD}</a>\n        </p>`;Dialog.show("Hermitowski.Helper",o)}async function i(e){"string"!=typeof e&&(e=JSON.stringify(e));const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}function r(e){return e<10?`0${e}`:`${e}`}function a(e){return parseInt((void 0!==e?e.getTime():Date.now())/1e3)}async function l(e){const t=new Promise(((t,n)=>{e.onsuccess=function(e){t(e.target.result)},e.onerror=function(e){n(e)}}));return await t}function s(e,t){return Math.floor(Math.random()*(t-e)+e)}const c="name",_="value",g="expiration_time_s",u=async function(t){const n="Hermitowski.MapFiles",o=e(n),r=await async function(){const t="Hermitowski.Storage",n=e(t),o="storage",r="readwrite",a="readonly",s="relaxed";n.entry(arguments),n.log("Opening database");const u=window.indexedDB.open(t,1);u.onupgradeneeded=function(e){const t=e.target.result.createObjectStore(o,{keyPath:c,autoIncrement:!1});t.createIndex(c,c,{unique:!0}),t.createIndex(g,g,{unique:!1})};const p=await l(u),f=function(){return parseInt(Date.now()/1e3)};n.log("Deleting expired items"),p.transaction(o,r).objectStore(o).index(g).openCursor(IDBKeyRange.upperBound(f())).onsuccess=function(e){var t=e.target.result;t&&(n.log(t),t.delete(),t.continue())};const d=async function(e,t){return e+"."+("string"==typeof t?t:await i(t))};return n.exit(),{get_item:async function(e,t){n.entry(arguments);const i=await d(e,t),r=await l(p.transaction(o,a,{durability:s}).objectStore(o).get(i));return n.log(i,r,f()),n.exit(),r&&r.expiration_time_s>f()?r:null},set_item:async function(e,t,i,a){n.entry(arguments);const s=await d(e,t),u={[c]:s,[g]:f()+a,[_]:i};n.log(u),await l(p.transaction(o,r).objectStore(o).put(u)),n.exit()},get_or_add_item:async function(e,t,i){n.entry(arguments);const c=await d(e,t);let _=await l(p.transaction(o,a,{durability:s}).objectStore(o).get(c));return(!_||_.expiration_time_s<f())&&(_=await i(),_.name=c,n.log("created instance",_),await l(p.transaction(o,r,{durability:s}).objectStore(o).put(_))),_.name=t,n.log("returning",_),n.exit(),_}}}(t),u=async function(e){o.entry(arguments);var t=[];for(const o of e){var i=r.get_or_add_item(n,o,(async function(){return await p(o)}));t.push(i)}var a=await Promise.all(t),l={};for(const e of a)l[e.name]=e;return o.exit(),l},p=async function(e){switch(e){case"village":return await f(e,(e=>({id:e[0],x:parseInt(e[2]),y:parseInt(e[3]),player_id:e[4]})));case"player":return await f(e,(e=>({id:e[0],name:e[1],ally_id:e[2]})));case"ally":return await f(e,(e=>({id:e[0],name:e[1],tag:e[2]})));case"building_info":case"unit_info":case"config":return await d(e);default:throw new Error(`Not supported entity name - ${e}`)}},f=async function(e,t){o.entry(arguments);const n=await fetch(`map/${e}.txt`),i=new Date(n.headers.get("last-modified")),r=await n.text(),l=r.split("\n"),u=l.filter((e=>e.trim().length>0)).map((e=>e.split(",").map((e=>m(e))))),p=[];for(const e of u)p.push(t(e));let f=a(i)+3600+s(15,120);return f<a()&&(f=a()+3600),o.exit(),{[c]:"",[g]:f,[_]:p}},d=async function(e){o.entry(arguments);const t=await fetch(`interface.php?func=get_${e}`),n=await t.text(),i=R(n);return o.exit(),{[c]:"",[g]:a()+3600,[_]:i}},y=new RegExp(/\+/,"g"),m=function(e){return decodeURIComponent(e.replace(y," "))},R=function(e){const t=(new window.DOMParser).parseFromString(e,"text/xml");return O(t.children[0])},O=function(e){let t={};if(0===e.childElementCount)return e.textContent;for(const n of e.children)t[n.nodeName]=O(n);return t};return{get_world_info:async function(e){o.entry(arguments);const t=await u(e);for(const n of e)t[n]=t[n].value;return o.exit(),t},get_item:async function(e){const n=await r.get_item(t,e);return n?n.value:null},set_item:async function(e,n,o){return await r.set_item(t,e,n,o)},get_or_compute:async function(e,n,a){o.entry(arguments);const l="string"==typeof a?a:await i(a),s=async function(){o.entry(arguments);const t=await u(n),i={};for(const e of n)i[e]=t[e].value;o.log("Passing following arguments into factory method",i,a);const r=await e(i,a);o.log("Computed result",r);const l=Math.min(...Object.keys(t).map((e=>t[e].expiration_time_s)));o.log("Expiration time set to",l);const s={[c]:"",[g]:l,[_]:r};return o.exit(),s};var p=await r.get_or_add_item(t,l,s);return o.exit(),p.value},get_or_compute_dynamic:async function(e,n,l){o.entry();const s=await i(e.toString()+JSON.stringify(n));o.log("Digest: ",s);var u=await r.get_or_add_item(t,s,(async function(){o.entry();const t=await e(n),i=a()+l;o.log("Expiration time set to",i);const r={[c]:"",[g]:i,[_]:t};return o.exit(),r}));return o.exit(),u.value}}};!async function(){const t=n(436),i="Hermitowski.Faking",l="0",s={map_files:null,logger:null,world_info:null,units:null,default_settings:{safeguard:{},troops_templates:[{spy:1,ram:1},{spy:1,catapult:1},{ram:1},{catapult:1}],fill_exact:!1,fill_troops:"spear,sword,axe,archer,spy,light,marcher,heavy,ram,catapult",changing_village_enabled:!0,coords:"",players:"",allies:"",ally_tags:"",include_barbarians:!1,boundaries:[],forum_config:{thread_id:null,page:0,spoiler_name:null,ttl:300},blocking_enabled:!1,blocking_local:{time:5,count:1,block_players:!0,scope:"village"},blocking_global:[{time:10,count:1,name:"global_1",block_players:!1}],skip_night_bonus:!0,date_ranges:[]},settings:{},input_data:async function(e,n){s.logger.entry(arguments);for(const t in e)document.querySelector(`#unit_input_${t}`).value=e[t]>0?e[t]:"";const o=document.querySelector(".target-input-field");o?o.value=`${n[0]}|${n[1]}`:(document.querySelector("#inputx").value=n[0],document.querySelector("#inputy").value=n[1]);const i=s.get_troops_speed(e),a=s.calculate_arrival_time(n,i);s.logger.log("Speed: ",i,"Arrival time",a);let l="";n[3]&&(l+=n[3]),n[4]&&(l+=` [${n[4]}]`);const c=t.ATTACK_TIME.replace("__DAY__",r(a.getDate())).replace("__MONTH__",r(a.getMonth()+1)).replace("__HOURS__",r(a.getHours())).replace("__MINUTES__",r(a.getMinutes())).replace("__PLAYER_INFO__",l).replace("__TARGET__",`${n[0]}|${n[1]}`);await s.add_to_block_tables(n),UI.SuccessMessage(c),s.logger.exit()},calculate_arrival_time:function(e,t){const n=s.calculate_distance(e);return new Date(1e3*(s.current_timestamp_s+n*t*60))},calculate_distance:function(e){return Math.hypot(game_data.village.x-e[0],game_data.village.y-e[1])},load_config:async function(e){if(s.logger.entry(arguments),"object"!=typeof e)throw t.ERROR_CONFIGURATION_MISSING;if(null!=e.forum_config){const n=e.forum_config;if("string"!=typeof n.spoiler_name)throw t.ERROR_FORUM_CONFIG_SPOILER_NAME;if(isNaN(parseInt(n.thread_id)))throw t.ERROR_FORUM_CONFIG_THREAD_ID;n.thread_id=parseInt(n.thread_id),s.logger.log(n),e=await s.load_config_from_forum(n)}for(const n in e)if(!s.default_settings.hasOwnProperty(n))throw t.ERROR_CONFIGURATION_OPTION_UNKNOWN.replace("__OPTION_NAME__",n);const n={date_ranges:function(e){const t=function(e){const t=e.match(/\d+/g)||[];return 5==t.length||2==t.length?[-1,-1,-1,...t.map(Number)].slice(-5):null},n=[];if(Array.isArray(e)){for(const o of e)if("string"==typeof o){const e=o.split("-");if(2==e.length){const o=[t(e[0]),t(e[1])];o[0]&&o[1]&&n.push(o)}}return n}},boundaries:function(e){const t=[];if(Array.isArray(e))for(const n of e)n.hasOwnProperty("center")&&"string"==typeof n.center&&(n.center=n.center.split("|").map(Number)),t.push(n);return t}};for(const t in s.default_settings)if(null!=e[t]){const o=n[t];s.settings[t]=o?o(e[t]):JSON.parse(JSON.stringify(e[t]))}else s.settings[t]=s.default_settings[t];s.logger.log("Configuration",s.settings),s.logger.exit()},load_config_from_forum:async function(e){s.logger.entry(arguments);const n=await s.map_files.get_or_compute_dynamic((async function(e){const n=TribalWars.buildURL("GET","forum",{screenmode:"view_thread",thread_id:e.thread_id,page:e.page||0});s.logger.log("Fetching",n);const o=await fetch(n),i=await o.text(),r=document.createElement("document");r.innerHTML=i;const a=[...r.querySelectorAll("div.forum-content")].pop();if(!a)throw t.ERROR_FORUM_CONFIG_THREAD_DOES_NOT_EXIST;const l=a.querySelectorAll(`div.spoiler > input[value="${e.spoiler_name}"]`);if(0==l.length)throw t.ERROR_FORUM_CONFIG_SPOILER_NONE;if(l.length>1)throw t.ERROR_FORUM_CONFIG_SPOILER_MULTIPLE;const c=l[0].parentElement;s.logger.log(c);const _=c.querySelectorAll("pre");if(0==_.length)throw t.ERROR_FORUM_CONFIG_CODE_SNIPPET_NONE;if(_.length>1)throw t.ERROR_FORUM_CONFIG_CODE_SNIPPET_MULTIPLE;const g=_[0].innerText,u=JSON.parse(g);return s.logger.log("Extracted",g,u),u}),e,e.ttl||3600);return s.logger.exit(),n},check_screen:function(){if(document.querySelector(".jump_link")&&this.change_village(t.ERROR_SCREEN_VILLAGE_OUT_OF_GROUP),"place"!==game_data.screen||1!==$("#command-data-form").length)throw location=TribalWars.buildURL("GET","place",{mode:"command"}),t.ERROR_SCREEN_REDIRECT;if(document.querySelector("#troop_confirm_go")||document.querySelector("#troop_confirm_submit"))throw t.ERROR_SCREEN_NO_ACTION},change_village:function(e){if(s.settings.changing_village_enabled){const e=document.querySelector("#village_switch_right"),t=document.querySelector(".jump_link");e?location=e.href:t&&(location=t.href)}throw e},select_troops:function(){if(s.logger.entry(arguments),s.clear_form(),s.settings.troops_templates.length>0){for(const e of s.settings.troops_templates){const t=JSON.parse(JSON.stringify(e));if(s.try_select_troops(t))return s.logger.log("Selecting",t),s.logger.exit(),t}s.change_village(t.ERROR_TROOPS_NOT_ENOUGH)}s.change_village(t.ERROR_TROOPS_EMPTY),s.logger.exit()},try_select_troops:function(e){s.logger.entry(arguments);const t=s.get_available_troops();s.logger.log("Available troops",t),s.logger.log("Inspecting",e);for(const n in e)if(t[n]<e[n])return s.logger.log("Skipping template. Required ",n,":",e[n]," got only",t[n]),!1;const n=Number(s.world_info.config.game.fake_limit);if(0==n)return s.logger.log("There is no fake limit"),s.logger.exit(),e;if(5==e.spy&&Object.keys(e).filter((e=>"spy"!==e)).every((t=>0==e[t])))return s.logger.log("Special case. Only 5 spies"),s.logger.exit(),e;const o=Math.floor(game_data.village.points*n*.01);s.logger.log("Population required",o);const i=s.count_population(e);s.logger.log("Template population",i);for(const t of s.units)e.hasOwnProperty(t)||(e[t]=0);const r=s.settings.fill_troops.split(",");let a=o-i;s.logger.log("fill_troops",r);for(const n of r){const o=n.split(":"),i=o[0],r=[];if(t[i]-e[i]>0&&r.push(t[i]-e[i]),o.length>1&&r.push(Number(o[1])),r.length>0){(!s.settings.fill_exact||s.settings.fill_exact>a>0)&&r.push(Math.ceil(a/s.world_info.unit_info[i].pop));const t=Math.min(...r);e[i]+=t,a-=s.world_info.unit_info[i].pop*t,s.logger.log("Population left",a,"fill_entry",n,"unit",i,"unit_count",t)}}return s.logger.exit(),a<=0},select_target:async function(e){s.logger.entry(arguments);const t=s.get_troops_speed(e);s.logger.log("Troops speed",t);let n=await s.pool_get();s.logger.log("Initial pool",n),n=await s.pool_apply_troops_constraints(n,e),s.logger.log("After applying troops constraints",n),n=await s.pool_apply_blocking(n),s.logger.log("After blocking",n),n=await s.pool_apply_date_ranges(n,e),s.logger.log("After applying date ranges ",n);const o=n[Math.floor(Math.random()*n.length)];return s.logger.log("Returning",o),s.logger.exit(),o},pool_get:async function(){s.logger.entry(arguments);const e={allies:s.settings.allies,ally_tags:s.settings.ally_tags,players:s.settings.players,include_barbarians:s.settings.include_barbarians,boundaries:s.settings.boundaries,coords:s.settings.coords},n=await s.map_files.get_or_compute((async function(e,t){s.logger.entry();const n=t.players.split(",").map((e=>e.trim().toLowerCase())),o=t.allies.split(",").map((e=>e.trim().toLowerCase())),i=t.ally_tags.split(",").map((e=>e.trim().toLowerCase()));s.logger.log("Players",n,"Allies",o,"Ally tags",i);const r=new Set(e.ally.filter((e=>o.includes(e.name.toLowerCase())||i.includes(e.tag.toLowerCase()))).map((e=>e.id))),a=new Set(e.player.filter((e=>n.includes(e.name.toLowerCase())||r.has(e.ally_id))).map((e=>e.id)));s.logger.log("Player ids",a);const c=new Set,_=[];let g=e.village.filter((e=>t.include_barbarians&&e.player_id===l||a.has(e.player_id)));s.logger.log("Villages before applying boundaries",g),t.boundaries.length&&(g=g.filter((e=>s.is_in_any_boundary(e,t.boundaries)))),s.logger.log("Villages after applying boundaries",g);for(const t of g){const n=t.player_id!==l?e.player.find((e=>e.id==t.player_id)):null,o=null!=n&&"0"!==n.ally_id?e.ally.find((e=>e.id==n.ally_id)):null,i=n?n.name:null,r=o?o.tag:null;_.push([t.x,t.y,t.player_id,i,r]),c.add(1e3*t.x+t.y)}const u=new RegExp(/\d{1,3}\|\d{1,3}/g),p=t.coords.match(u);if(null!=p)for(const t of p.map((e=>e.split("|").map(Number)))){const n=1e3*t[0]+t[1];if(!c.has(n)){const o=e.village.find((e=>e.x==t[0]&&e.y==t[1]));o&&(_.push([o.x,o.y,o.player_id]),c.add(n))}}return s.logger.exit(),_}),["ally","player","village"],e);if(0===n.length)throw t.ERROR_POOL_EMPTY;return s.logger.exit(n),n},is_in_any_boundary:function(e,t){for(const n of t)if(n.hasOwnProperty("center")){const t=n.center[0]-e.x,o=n.center[1]-e.y;if(t*t+o*o<=n.r*n.r)return s.logger.log("Accepting village",e," in circle"),!0}else if(n.hasOwnProperty("min_x")&&n.min_x<=e.x&&e.x<=n.max_x&&n.min_y<=e.y&&e.y<=n.max_y)return s.logger.log("Accepting village",e," in box"),!0;return!1},pool_apply_date_ranges:async function(e,n){s.logger.entry(arguments);const o=s.get_troops_speed(n),i=Object.keys(n).filter((e=>"spy"!==e)).every((e=>0==n[e]));if("1"===s.world_info.config.night.active&&s.settings.skip_night_bonus&&!i){const n=Number(s.world_info.config.night.start_hour),i=Number(s.world_info.config.night.end_hour);if(0===(e=e.filter((e=>{if(e[2]===l)return!0;const t=s.calculate_arrival_time(e,o);return n>i?t.getHours()<n&&t.getHours()>i-1:n<=t.getHours()&&t<=i-1}))).length)throw t.ERROR_POOL_EMPTY_NIGHT_BONUS}const r=function(e){return 60*e[3]+e[4]};if(s.logger.log("Faking.settings.date_ranges",s.settings.date_ranges),s.settings.date_ranges.length>0){const n=e;for(const t of s.settings.date_ranges){s.logger.log("date_range",t);let i=null;if(-1!=t[0][0]&&-1!=t[1][0]){const e=new Date(t[0][2],t[0][1]-1,t[0][0],t[0][3],t[0][4]),n=new Date(t[1][2],t[1][1]-1,t[1][0],t[1][3],t[1][4]);s.logger.log("lower_bound",e,"upper_bound",n),i=function(t){const i=s.calculate_arrival_time(t,o);return s.logger.log(t,e<=i&&i<=n,i),e<=i&&i<=n}}else{const e=r(t[0]),n=r(t[1]);s.logger.log("Minutes from",e,n),i=function(t){const i=s.calculate_arrival_time(t,o),a=r([-1,-1,-1,i.getHours(),i.getMinutes()]);return s.logger.log(t,a,e<=a&&a<=n,i),e<=a&&a<=n}}if((e=n.filter(i)).length>0)break}if(0==e.length)throw t.ERROR_POOL_EMPTY_DATE_RANGES}return s.logger.exit(e),e},pool_apply_troops_constraints:function(e,n){return s.logger.entry(arguments),n.snob>0&&(s.logger.log(e.map((e=>s.calculate_distance(e)))),0===(e=e.filter((e=>s.calculate_distance(e)<Number(s.world_info.config.snob.max_dist)))).length&&s.change_village(t.ERROR_POOL_EMPTY_SNOBS)),s.logger.exit(e),e},pool_apply_blocking:async function(e){return s.logger.entry(arguments),s.settings.blocking_enabled&&(e=await s.pool_apply_blocking_local(e),e=await s.pool_apply_blocking_global(e)),s.logger.exit(e),e},pool_apply_blocking_local:async function(e){return s.logger.entry(arguments),e=await s.pool_apply_block_table(e,s.blocking_local_get_key(),s.settings.blocking_local.count,s.settings.blocking_local.block_players),s.logger.exit(e),e},pool_apply_blocking_global:async function(e){s.logger.entry(arguments);for(const t of s.settings.blocking_global)e=await s.pool_apply_block_table(e,s.blocking_global_get_key(t.name),t.count,t.block_players);return s.logger.exit(e),e},blocking_local_get_key:function(){return"village"===s.settings.blocking_local.scope?`blocking.l.${game_data.village.id}`:{village_id:game_data.village.id,settings:s.settings}},blocking_global_get_key:function(e){return`blocking.g.${e}`},pool_apply_block_table:async function(e,n,o,i){s.logger.entry(arguments);const r=await s.block_table_get(n),a=new Map,c=new Set,_=function(e){return 1e3*e[0]+e[1]};for(const e of r){const t=_(e[1]);if(a.has(t)?a.set(t,a.get(t)+1):a.set(t,1),i){const t=e[1][2];t!=l&&c.add(t)}}if(s.logger.log(a,c),s.logger.log("Block table",r),0===(e=e.filter((e=>{const t=_(e);return(a.get(t)||0)<o}))).length)throw t.ERROR_POOL_EMPTY_BLOCKED_VILLAGES;if(i&&0===(e=e.filter((e=>{const t=e[2];return!c.has(t)}))).length)throw t.ERROR_POOL_EMPTY_BLOCKED_PLAYERS;return s.logger.log("After applying block table",n,e),s.logger.exit(e),e},add_to_block_tables:async function(e){if(s.settings.blocking_enabled){await s.block_table_add_entry(e,s.blocking_local_get_key(),s.settings.blocking_local.time);for(const t of s.settings.blocking_global)await s.block_table_add_entry(e,s.blocking_global_get_key(t.name),t.time)}},block_table_get:async function(e){s.logger.entry(arguments);let t=await s.map_files.get_item(e)||[];const n=parseInt(Date.now()/1e3);for(let o=0;o<t.length;o++)if(t[o][0]>n){o>0&&(s.logger.log("Trimming",e,"block table by",o,"entries"),t=t.slice(o));break}return s.logger.exit(t),t},block_table_add_entry:async function(e,t,n){s.logger.entry(arguments);const o=await s.block_table_get(t),i=parseInt(Date.now()/1e3)+n,r=[i,e];s.logger.log("Adding block entry",r),o.push(r),await s.map_files.set_item(t,o,n),s.logger.exit()},get_troops_speed:function(e){let n=0;for(const t in e)e.hasOwnProperty(t)&&0!==e[t]&&(n=Math.max(Number(s.world_info.unit_info[t].speed),n));if(0===n)throw t.ERROR_TROOPS_EMPTY;return n},count_population:function(e){return Object.keys(e).map((t=>e[t]*Number(s.world_info.unit_info[t].pop))).reduce(((e,t)=>e+t),0)},clear_form:function(){for(const e of[...document.querySelectorAll("[id^=unit_input_]"),document.querySelector(".target-input-field"),document.querySelector("#inputx"),document.querySelector("#inputy")])e&&(e.value="")},get_available_troops:function(){const e={};for(let t of s.units)e[t]=Number(document.querySelector(`#unit_input_${t}`).dataset.allCount),s.settings.safeguard.hasOwnProperty(t)&&(e[t]=Math.max(0,e[t]-s.settings.safeguard[t]));return e},load_infrastructure:async function(){s.logger=await e(i),s.map_files=await u(i)},init:async function(){s.logger.entry(arguments);const e=["config","unit_info"];s.world_info=await s.map_files.get_world_info(e),s.units=game_data.units.filter((e=>"militia"!==e)),s.current_timestamp_s=a(),s.logger.exit()},main:async function(e){s.logger.entry(arguments),s.check_screen(),await s.load_config(e),await s.init();const t=s.select_troops(),n=await s.select_target(t);await s.input_data(t,n),s.logger.exit()}};try{await s.load_infrastructure(),await s.main("object"==typeof HermitowskieFejki?HermitowskieFejki:void 0)}catch(e){o(e,t.FORUM_THREAD_HREF)}}()})()})();